<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ê³ ê¸‰ ë¹„ìœ¨ ë£°ë › (v28 - ì˜¤ë¥˜ ìˆ˜ì • ë° ìµœì¢…)</title>
<style>
  /* --- CSS ìŠ¤íƒ€ì¼ (ì´ì „ê³¼ ë™ì¼) --- */
* { box-sizing: border-box; margin: 0; padding: 0; }
body { min-height: 100vh; background: #f0f0f0; font-family: sans-serif; padding-right: 0; transition: padding-right 0.3s ease-in-out; overflow-y: scroll; }
body.panel-visible { padding-right: 350px; }
.roulette-container { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; width: 100%; transition: width 0.3s ease-in-out; padding: 20px; position: relative; }
#rouletteTitle { width: clamp(300px, 80%, 600px); padding: 10px 15px; font-size: 1.2em; text-align: center; border: 2px solid #ccc; border-radius: 8px; margin-bottom: 60px; background-color: #fff; }
#roulette-wrapper { position: relative; width: clamp(300px, 80vmin, 600px); aspect-ratio: 1 / 1; margin-bottom: 20px; }
#roulette { width: 100%; height: 100%; border-radius: 50%; overflow: hidden; border: 5px solid #333; position: absolute; top: 0; left: 0; }

#pointer {
  position: absolute; top: 50%; left: 0; transform: translateY(-50%); width: 0; height: 0;
  border-top: 20px solid transparent; border-bottom: 20px solid transparent; border-left: 40px solid red; z-index: 100;
}
#pointerLabelBoxWrapper {
  position: absolute; top: 50%; left: -170px; transform: translateY(-50%); width: 150px; height: 50px;
  overflow: hidden; border: 2px solid #333; background: #fff; border-radius: 5px; z-index: 101; pointer-events: none;
}
#pointerLabelBox {
  position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;
  font-weight: bold; font-size: 1.2em; text-align: center;
}
#currentItemName {
  width: 100%; display: flex; align-items: center; justify-content: center; height: 100%;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 5px;
}

#spinButton { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80px; height: 80px; border-radius: 50%; background-color: #4CAF50; color: white; border: 3px solid white; box-shadow: 0 4px 8px rgba(0,0,0,0.3); font-size: 1.1em; font-weight: bold; cursor: pointer; z-index: 150; display: flex; justify-content: center; align-items: center; transition: background-color 0.2s; }
#spinButton:hover { background-color: #45a049; }
#spinButton:disabled { background: #ccc; cursor: not-allowed; border-color: #eee; }

#spinButton.stop-mode {
  background-color: #f44336 !important; /* ê°•ë ¬í•œ ë¹¨ê°• */
  border-color: #fff;
  color: #fff;
}
#spinButton.stop-mode:hover {
  background-color: #c62828 !important; /* ë” ì§„í•œ ë¹¨ê°• */
}

#resultDisplay { margin-top: 10px; font-size: 1.5em; font-weight: bold; color: #333; min-height: 1.5em; text-align: center; }

.input-panel { position: fixed; top: 0; right: 0; width: 350px; height: 100vh; background: white; padding: 60px 20px 20px 20px; box-shadow: -2px 0 10px rgba(0,0,0,0.1); transform: translateY(0); visibility: visible; transition: transform 0.4s ease-in-out, visibility 0.4s; display: flex; flex-direction: column; gap: 10px; z-index: 200; overflow: hidden; }
body.panel-hidden .input-panel { transform: translateY(-100%); visibility: hidden; }
#toggleButton { position: fixed; top: 10px; right: 10px; z-index: 210; padding: 8px 15px; }
body.panel-hidden { padding-right: 0; }
#dataInput { width: 100%; height: 200px; min-height: 100px; padding: 10px; border: 2px solid #ddd; border-radius: 5px; resize: vertical; font-size: 1em; flex-shrink: 0; }
.panel-controls { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 5px; flex-shrink: 0; padding: 5px 0; }
.panel-controls button { font-size: 0.9em; padding: 5px 10px; flex-grow: 1; }
#togglePercentageBtn { background-color: #6c757d; }
#togglePercentageBtn:hover { background-color: #5a6268; }
#shuffleBtn { background-color: #007bff;}
#shuffleBtn:hover { background-color: #0056b3; }

.history-section { border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px; display: flex; flex-direction: column; overflow: hidden; }
#inputHistorySection { flex-grow: 1; }
#resultHistorySection { flex-grow: 0; flex-shrink: 0; margin-top: auto; padding-top: 10px; border-top: 1px solid #eee;}
.history-section h3 { margin-bottom: 5px; font-size: 1.1em; flex-shrink: 0; cursor: pointer; user-select: none; display: inline-block; }
.history-section h3:hover { color: #4CAF50; }
#inputHistorySection ul { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; max-height: 100%; }
#inputHistorySection li { padding: 8px 5px; border-bottom: 1px dashed #eee; cursor: default; display: flex; justify-content: space-between; align-items: center; gap: 5px; }
#inputHistorySection li:hover { background-color: #f0f0f0; }
#inputHistorySection li:last-child { border-bottom: none; }
#inputHistoryList li .history-items { flex-grow: 1; white-space: pre-wrap; word-break: break-all; font-size: 0.9em; cursor: pointer; }
#inputHistoryList li .history-items:hover { color: #007bff; }
#inputHistoryList li .history-timestamp { font-size: 0.8em; color: #777; margin-top: 3px; display: block; pointer-events: none; }
#inputHistoryList .item-actions { display: flex; gap: 5px; flex-shrink: 0; }

button { background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; padding: 10px 15px; transition: background-color 0.2s; }
button:hover { background: #45a049; } button:disabled { background: #ccc; cursor: not-allowed; }
.icon-button { background: none; border: none; color: #6c757d; font-size: 18px; cursor: pointer; padding: 0 3px; line-height: 1; vertical-align: middle; transition: color 0.2s; }
.icon-button:hover { color: #343a40; }
.delete-button { color: #dc3545; }
.delete-button:hover { color: #c82333; }
.favorite-button { color: #adb5bd; font-size: 16px; }
.favorite-button:hover { color: #6c757d; }
.favorite-button.favorited { color: #ffc107; }
.favorite-button.favorited:hover { color: #e0a800; }
.edit-favorite-button { color: #007bff; font-size: 16px; }
.edit-favorite-button:hover { color: #0056b3; }

.error-message { color: red; font-size: 0.9em; min-height: 20px; flex-shrink: 0;}
.sector-text { fill: #000; text-anchor: middle; alignment-baseline: middle; pointer-events: none; }
.sector-text tspan { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* --- íŒì—… ìŠ¤íƒ€ì¼ --- */
.popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s; }
.popup-overlay.visible { opacity: 1; visibility: visible; }
.popup-content { background: #4CAF50; color: white; padding: 25px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); text-align: center; min-width: 300px; max-width: 90vw; max-height: 85vh; display: flex; flex-direction: column; gap: 15px; position: relative; transform: scale(0.9); transition: transform 0.3s ease; }
.popup-overlay.visible .popup-content { transform: scale(1); }
.popup-content h2 { color: #fff; font-size: 1.5em; margin: 0 0 10px 0; }
.popup-content button { font-size: 0.9em; padding: 8px 15px; }
.popup-content .popup-close-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.8rem; color: #eee; cursor: pointer; line-height: 1; padding: 0; }
.popup-content .popup-close-btn:hover { color: #fff; }
.popup-content .popup-button-group { display: flex; justify-content: center; gap: 10px; margin-top: 15px; flex-shrink: 0; }
.popup-content .popup-button-group .confirm-btn { background-color: #28a745; }
.popup-content .popup-button-group .confirm-btn:hover { background-color: #218838; }
.popup-content .popup-button-group .cancel-btn { background-color: #6c757d; }
.popup-content .popup-button-group .cancel-btn:hover { background-color: #5a6268; }
#customPopup button { background: white; color: #4CAF50; }
#customPopup button:hover { background: #f0f0f0; }
#customPopup .remove-btn { background-color: #dc3545; color: white; }
#customPopup .remove-btn:hover { background-color: #c82333; }

.popup-list-container { width: 100%; flex-grow: 1; overflow-y: auto; border: 1px solid #eee; padding: 10px; background-color: #f9f9f9; text-align: left; margin-bottom: 15px; }
.popup-list-container ul { list-style: none; padding: 0; margin: 0; }
.popup-list-container li { padding: 10px 5px; border-bottom: 1px dashed #ccc; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
.popup-list-container li:last-child { border-bottom: none; }
.popup-list-container .item-name { flex-grow: 1; font-size: 1em; cursor: pointer; }
.popup-list-container .item-name:hover { color: #007bff; }
.popup-list-container .item-timestamp { font-size: 0.8em; color: #777; flex-shrink: 0; margin-left: 10px; }
.popup-list-container .item-actions { display: flex; gap: 5px; flex-shrink: 0; }
#favoriteNameInput { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }


/* íŒì—… ì „ì²´ í…ìŠ¤íŠ¸ì— ê·¸ë¦¼ì ë° ë” ì§„í•œ ìƒ‰ìƒ */
.popup-content,
.popup-content h2,
.popup-content p,
.popup-list-container,
.popup-list-container li,
.popup-list-container .item-name {
  color: #fff !important;
  text-shadow: 0 1px 4px rgba(0,0,0,0.45), 0 0 1px #333;
  font-weight: 600;
}

/* ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ ë°°ê²½ì„ ì‚´ì§ ì–´ë‘¡ê²Œ í•˜ì—¬ ëŒ€ë¹„ ê°•í™” */
.popup-list-container {
  background: rgba(0,0,0,0.15) !important;
}

/* ë¦¬ìŠ¤íŠ¸ í•­ëª© ê°•ì¡° */
.popup-list-container li {
  background: rgba(255,255,255,0.08);
  border-radius: 6px;
  margin-bottom: 6px;
  color: #fff !important;
  padding: 12px 8px;
  font-size: 1.07em;
  font-weight: 600;
  transition: background 0.2s;
}
.popup-list-container li:hover {
  background: rgba(255,255,255,0.18);
}

/* í•­ëª© ì´ë¦„ ê°•ì¡° */
.popup-list-container .item-name {
  color: #fff !important;
  font-weight: bold;
  text-shadow: 0 1px 4px rgba(0,0,0,0.45);
}

/* íƒ€ì„ìŠ¤íƒ¬í”„ ìƒ‰ìƒ ë°ê²Œ */
.popup-list-container .item-timestamp,
.popup-list-container .result-timestamp {
  color: #ffe066 !important;
  font-size: 0.93em;
  text-shadow: 0 1px 4px rgba(0,0,0,0.55);
}

/* ë²„íŠ¼ë„ ë” ë°ê²Œ, í…Œë‘ë¦¬/ë°°ê²½ ëŒ€ë¹„ ê°•í™” */
.popup-content button,
.popup-content .popup-close-btn {
  background: #fff !important;
  color: #388e3c !important;
  font-weight: bold;
  border: 2px solid #388e3c;
  text-shadow: none;
  box-shadow: 0 2px 8px rgba(0,0,0,0.12);
  transition: background 0.2s, color 0.2s;
}
.popup-content button:hover,
.popup-content .popup-close-btn:hover {
  background: #ffe066 !important;
  color: #222 !important;
}

/* ì…ë ¥ì°½ ê°•ì¡° */
#favoriteNameInput {
  background: #fff !important;
  color: #222 !important;
  border: 2px solid #388e3c !important;
  font-weight: bold;
}

/* ë‹¹ì²¨ ë©”ì‹œì§€(ì˜ˆ: ğŸ‰ ì´ë¦„ ğŸ‰) ê°•ì¡° */
#customPopup p {
  font-size: 2em !important;
  color: #ffe066 !important;
  text-shadow: 0 2px 8px rgba(0,0,0,0.45), 0 0 2px #333;
  font-weight: bold;
}




@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }
.blink-effect { animation: blink 1s ease-in-out 3; }



.edit-favorite-input {
  width: 120px;
  font-size: 1em;
  margin-right: 4px;
}



.edit-favorite-btn,
.save-edit-favorite,
.cancel-edit-favorite,
.delete-favorite-button {
  min-width: 28px;
  height: 28px;
  font-size: 1.1em;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  vertical-align: middle;
  background: none;
  border: none;
  cursor: pointer;
  margin-left: 4px;
  margin-right: 4px;
  transition: color 0.2s;
}
.edit-favorite-input {
  width: 120px;
  font-size: 1em;
  margin-right: 4px;
  vertical-align: middle;
}




</style>
</head>
<body class="panel-visible">

<button id="toggleButton">â–² ìˆ¨ê¸°ê¸°</button>

<div class="roulette-container">
  <input type="text" id="rouletteTitle" placeholder="ë£°ë › ì œëª© ì…ë ¥">
  <div id="roulette-wrapper">
    <div id="pointerLabelBoxWrapper">
        <div id="pointerLabelBox">
            <span id="currentItemName">í•­ëª© ì´ë¦„</span>
        </div>
    </div>
    <div id="pointer"></div>
    <div id="roulette"></div>
    <button id="spinButton">ëŒë¦¬ê¸°</button>
  </div>
  <div id="resultDisplay">ê²°ê³¼:</div>
</div>

<div class="input-panel">
   <textarea id="dataInput"
     placeholder="ë¹„ìœ¨ ë£°ë ›ì…ë‹ˆë‹¤.&#10;í•­ëª©ëª…ì„ ì…ë ¥í•˜ê³  ë³„í‘œ(*) ë’¤ì— ë¹„ìœ¨ì„ ì ìœ¼ì„¸ìš”.&#10;(ë¹„ìœ¨ì€ ì†Œìˆ˜ì  ê°€ëŠ¥)&#10;ì—”í„°í‚¤ë¡œ í•­ëª©ì„ êµ¬ë¶„í•©ë‹ˆë‹¤.&#10;ë³„í‘œì™€ ë¹„ìœ¨ ìƒëµ ì‹œ ë¹„ìœ¨ì€ 1ë¡œ ê°„ì£¼ë©ë‹ˆë‹¤.&#10;&#10;ì˜ˆì‹œ:&#10;ì§œì¥ë©´*5.5&#10;ì§¬ë½•*3&#10;ë³¶ìŒë°¥&#10;íƒ•ìˆ˜ìœ¡*2.1"
   ></textarea>
   <div class="error-message" id="error"></div>
   <div class="panel-controls">
       <button id="togglePercentageBtn">ë°±ë¶„ìœ¨ ìˆ¨ê¸°ê¸°</button>
       <button id="shuffleBtn">í•­ëª© ë’¤ì„ê¸°</button>
   </div>
   <div id="inputHistorySection" class="history-section">
       <h3 id="inputHistoryHeading">ì…ë ¥ í•­ëª© (í´ë¦­í•˜ì—¬ ì¦ê²¨ì°¾ê¸° ë³´ê¸°)</h3>
       <ul id="inputHistoryList"></ul>
   </div>
   <div id="resultHistorySection" class="history-section">
       <h3 id="resultHistoryHeading">ë‹¹ì²¨ ê²°ê³¼ (í´ë¦­í•˜ì—¬ ì €ì¥ ëª©ë¡ ë³´ê¸°)</h3>
   </div>
</div>

<script>
let currentRotation = 0, items = [], sectorData = [];
let resultHistoryList = [], inputHistoryList = [], favoritesList = [];
let isSpinning = false, debounceTimer, animationFrameId = null, lastDisplayedSector = null, showPercentage = true, isStopping = false;
const baseColors = ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF','#FF9F40','#E7E9ED','#77DD77'];
const spinSound = new Audio('Sound/spin.mp3'), resultSound = new Audio('Sound/result.mp3');
let rouletteElement, resultDisplay, spinButton, dataInputElement, errorElement, toggleBtn, inputHistoryListElement, rouletteTitleElement, pointerLabelBoxWrapper, currentItemNameElement, resultHistoryHeading, inputHistoryHeading, togglePercentageBtn, shuffleBtn;

document.addEventListener('DOMContentLoaded', () => {
    rouletteElement = document.getElementById('roulette');
    resultDisplay = document.getElementById('resultDisplay');
    spinButton = document.getElementById('spinButton');
    dataInputElement = document.getElementById('dataInput');
    errorElement = document.getElementById('error');
    toggleBtn = document.getElementById('toggleButton');
    inputHistoryListElement = document.getElementById('inputHistoryList');
    rouletteTitleElement = document.getElementById('rouletteTitle');
    pointerLabelBoxWrapper = document.getElementById('pointerLabelBoxWrapper');
    currentItemNameElement = document.getElementById('currentItemName');
    resultHistoryHeading = document.getElementById('resultHistoryHeading');
    inputHistoryHeading = document.getElementById('inputHistoryHeading');
    togglePercentageBtn = document.getElementById('togglePercentageBtn');
    shuffleBtn = document.getElementById('shuffleBtn');

    if(togglePercentageBtn) togglePercentageBtn.addEventListener('click', () => {
        showPercentage=!showPercentage;
        togglePercentageBtn.textContent=showPercentage?'ë°±ë¶„ìœ¨ ìˆ¨ê¸°ê¸°':'ë°±ë¶„ìœ¨ ë³´ê¸°';
        saveData(); drawRoulette(items);
    });
    if(shuffleBtn) shuffleBtn.addEventListener('click', shuffleItems);
    if(toggleBtn) toggleBtn.addEventListener('click', togglePanel);
    if(spinButton) spinButton.addEventListener('click', () => { if(!isSpinning) spinRoulette(); else stopRoulette(); });
    if(dataInputElement) dataInputElement.addEventListener('input', handleInput);
    if(inputHistoryListElement) inputHistoryListElement.addEventListener('click', handleInputHistoryInteraction);
    if(resultHistoryHeading) resultHistoryHeading.addEventListener('click', showHistoryPopup);
    if(inputHistoryHeading) inputHistoryHeading.addEventListener('click', showFavoritesPopup);

    loadInitialData();
    handleInput();
    rouletteElement.style.transform = `rotate(${currentRotation}deg)`;
});

function areItemSetsEqual(set1, set2) {
    if (!set1 || !set2 || set1.length !== set2.length) return false;
    const sortedSet1 = [...set1].sort((a, b) => a.name.localeCompare(b.name));
    const sortedSet2 = [...set2].sort((a, b) => a.name.localeCompare(b.name));
    return sortedSet1.every((item1, idx) => {
        const item2 = sortedSet2[idx];
        return item1.name === item2.name && item1.ratio === item2.ratio;
    });
}
function loadInitialData() {
    const savedTitle = localStorage.getItem('rouletteTitle'), savedItems = localStorage.getItem('rouletteItems');
    const savedResultHistory = localStorage.getItem('rouletteResultHistory'), savedInputHistory = localStorage.getItem('rouletteInputHistory');
    const savedRotation = localStorage.getItem('rouletteRotation'), savedFavorites = localStorage.getItem('rouletteFavorites');
    const savedShowPercentage = localStorage.getItem('rouletteShowPercentage');
    if(savedTitle) rouletteTitleElement.value = savedTitle;
    if(savedItems) dataInputElement.value = savedItems; else dataInputElement.value = 'ì§œì¥ë©´*5.5\nì§¬ë½•*3\në³¶ìŒë°¥\níƒ•ìˆ˜ìœ¡*2.1';
    if(savedResultHistory) try{resultHistoryList=JSON.parse(savedResultHistory)||[]}catch(e){resultHistoryList=[];}
    if(savedInputHistory) try{inputHistoryList=JSON.parse(savedInputHistory)||[]}catch(e){inputHistoryList=[];}
    if(savedRotation) currentRotation = parseFloat(savedRotation);
    if(savedFavorites) try{favoritesList=JSON.parse(savedFavorites)||[]}catch(e){favoritesList=[];}
    if(savedShowPercentage!==null) showPercentage = savedShowPercentage==='true';
    if(togglePercentageBtn) togglePercentageBtn.textContent = showPercentage ? 'ë°±ë¶„ìœ¨ ìˆ¨ê¸°ê¸°' : 'ë°±ë¶„ìœ¨ ë³´ê¸°';
}
function saveData() {
    localStorage.setItem('rouletteTitle', rouletteTitleElement.value);
    localStorage.setItem('rouletteItems', dataInputElement.value);
    localStorage.setItem('rouletteResultHistory', JSON.stringify(resultHistoryList));
    localStorage.setItem('rouletteInputHistory', JSON.stringify(inputHistoryList));
    localStorage.setItem('rouletteRotation', currentRotation.toString());
    localStorage.setItem('rouletteFavorites', JSON.stringify(favoritesList));
    localStorage.setItem('rouletteShowPercentage', showPercentage.toString());
}
function togglePanel() {
    const bodyEl = document.body;
    bodyEl.classList.toggle('panel-hidden');
    bodyEl.classList.toggle('panel-visible');
    toggleBtn.textContent = bodyEl.classList.contains('panel-hidden') ? 'â–¼ ë³´ê¸°' : 'â–² ìˆ¨ê¸°ê¸°';
}
function parseInput(text) {
    return text.split('\n').map(line=>line.trim()).filter(line=>line).map(line=>{
        const parts = line.split('*');
        const name = (parts[0]||'ë¬´ì œ').trim();
        let ratio = 1;
        if(parts.length>1 && parts[1].trim()) {
            const parsedRatio = parseFloat(parts[1].trim());
            if(!isNaN(parsedRatio) && parsedRatio>=0) ratio = parsedRatio;
        }
        return {name, ratio};
    }).filter(item=>item.name);
}
function getFontSizeByAngle(angle) {
    const minFontSize=6, maxFontSize=16, minAngle=5, maxAngle=45;
    if(angle<=minAngle) return minFontSize;
    if(angle>=maxAngle) return maxFontSize;
    return minFontSize+(maxFontSize-minFontSize)*(angle-minAngle)/(maxAngle-minAngle);
}
function drawRoulette(currentItems) {
    items = [...currentItems];
    const validItems = items.filter(item=>item.ratio>0);
    sectorData = [];
    const totalRatio = validItems.reduce((acc,item)=>acc+item.ratio, 0);
    rouletteElement.innerHTML = '';
    resultDisplay.textContent = 'ê²°ê³¼:';
    if(totalRatio<=0) {
        rouletteElement.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:#555;">í•­ëª© ì—†ìŒ</div>';
        currentItemNameElement.textContent = "í•­ëª© ì—†ìŒ";
        sectorData = [];
        return;
    }
    currentItemNameElement.textContent = "í•­ëª© ì´ë¦„";
    const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
    svg.setAttribute("width","100%"); svg.setAttribute("height","100%"); svg.setAttribute("viewBox","0 0 400 400");
    let startAngle = 0;
    // --- ìƒ‰ìƒ ê³ ì •: í•­ëª©ëª… ê¸°ì¤€ ---
    const colorMap = {};
    let colorIdx = 0;
    [...new Set(validItems.map(i=>i.name))].forEach(name=>{
        colorMap[name]=baseColors[colorIdx%baseColors.length];
        colorIdx++;
    });
    validItems.forEach((item,index)=>{
        const percentage = (item.ratio/totalRatio)*100, angle = (item.ratio/totalRatio)*360, endAngle=startAngle+angle;
        sectorData.push({name:item.name,ratio:item.ratio,percentage,startAngle,endAngle});
        const path = document.createElementNS("http://www.w3.org/2000/svg","path");
        const x1=200+200*Math.cos(Math.PI*startAngle/180), y1=200+200*Math.sin(Math.PI*startAngle/180);
        const x2=200+200*Math.cos(Math.PI*endAngle/180), y2=200+200*Math.sin(Math.PI*endAngle/180);
        path.setAttribute("d",`M200 200 L${x1} ${y1} A200 200 0 ${angle>=359.99?1:(angle>180?1:0)} 1 ${x2} ${y2} Z`);
        path.setAttribute("fill",colorMap[item.name]||'#cccccc');
        path.setAttribute("stroke","#fff"); path.setAttribute("stroke-width","1");
        svg.appendChild(path);
        if(angle>3) {
            const textAngle = startAngle+angle/2;
            const text = document.createElementNS("http://www.w3.org/2000/svg","text");
            const radius = angle>45?130:(angle>20?150:(angle>10?165:175));
            const textX=200+radius*Math.cos(Math.PI*textAngle/180), textY=200+radius*Math.sin(Math.PI*textAngle/180);
            text.setAttribute("x",textX); text.setAttribute("y",textY); text.setAttribute("class","sector-text");
            const rotateDeg=textAngle-180; text.setAttribute("transform",`rotate(${rotateDeg},${textX},${textY})`);
            const fontSize=getFontSizeByAngle(angle);
            const tspan1=document.createElementNS("http://www.w3.org/2000/svg","tspan");
            tspan1.setAttribute("x",textX); tspan1.textContent=item.name; tspan1.setAttribute('style',`font-size:${fontSize}px;`);
            if(showPercentage && angle>8) {
                tspan1.setAttribute("dy","-0.6em"); text.appendChild(tspan1);
                const tspan2=document.createElementNS("http://www.w3.org/2000/svg","tspan");
                tspan2.setAttribute("x",textX); tspan2.setAttribute("dy","1.2em");
                tspan2.textContent=`${item.ratio} (${percentage.toFixed(1)}%)`;
                const ratioFontSize=Math.max(5,fontSize-5); tspan2.setAttribute('style',`font-size:${ratioFontSize}px;`);
                text.appendChild(tspan2);
            } else { tspan1.setAttribute("dy","0.3em"); text.appendChild(tspan1);}
            svg.appendChild(text);
        }
        startAngle = endAngle;
    });
    rouletteElement.appendChild(svg);
    rouletteElement.style.transform = `rotate(${currentRotation}deg)`;
}
function shuffleItems() {
    if(isSpinning) return;
    let currentItemsParsed = parseInput(dataInputElement.value);
    if(currentItemsParsed.length<2) return;
    for(let i=currentItemsParsed.length-1;i>0;i--) {
        const j=Math.floor(Math.random()*(i+1));
        [currentItemsParsed[i],currentItemsParsed[j]]=[currentItemsParsed[j],currentItemsParsed[i]];
    }
    dataInputElement.value = currentItemsParsed.map(item=>`${item.name}${item.ratio!==1?'*'+item.ratio:''}`).join('\n');
    handleInput();
}
function handleInput() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
        if(!dataInputElement) return;
        const inputText = dataInputElement.value;
        const parsedItems = parseInput(inputText);
        if(errorElement) errorElement.textContent='';
        drawRoulette(parsedItems);
        updateInputHistoryDisplay();
        saveData();
    },300);
}
function updateInputHistoryDisplay() {
    if (!inputHistoryListElement) return; inputHistoryListElement.innerHTML = '';
    if (!inputHistoryList) inputHistoryList = [];
    inputHistoryList.forEach((historyEntry, index) => {
        const li = document.createElement('li'); li.setAttribute('data-index', index);
        const itemsDiv = document.createElement('div'); itemsDiv.classList.add('history-items'); itemsDiv.title = "í´ë¦­í•˜ì—¬ ë¶ˆëŸ¬ì˜¤ê¸°";
        itemsDiv.textContent = historyEntry.items ? historyEntry.items.map(item => `${item.name}(${item.ratio})`).join(', ') : 'í•­ëª© ì •ë³´ ì—†ìŒ';
        const timeSpan = document.createElement('span'); timeSpan.classList.add('history-timestamp'); timeSpan.textContent = new Date(historyEntry.timestamp).toLocaleString(); itemsDiv.appendChild(timeSpan); li.appendChild(itemsDiv);
        const actionsDiv = document.createElement('div'); actionsDiv.className = 'item-actions';
        const isFavorite = favoritesList && historyEntry.items ? favoritesList.some(fav => areItemSetsEqual(fav.items, historyEntry.items)) : false;
        const favBtn = document.createElement('button');
        favBtn.innerHTML = isFavorite ? 'ğŸŒŸ' : 'â˜†'; favBtn.classList.add('icon-button', 'favorite-button'); if (isFavorite) favBtn.classList.add('favorited'); favBtn.title = isFavorite ? "ì¦ê²¨ì°¾ê¸° ì œê±°" : "ì¦ê²¨ì°¾ê¸° ì¶”ê°€"; favBtn.setAttribute('data-index', index); actionsDiv.appendChild(favBtn);
        const deleteBtn = document.createElement('button'); deleteBtn.innerHTML = '&#x2716;'; deleteBtn.classList.add('icon-button', 'delete-button', 'delete-input-history'); deleteBtn.title = "ì‚­ì œ"; deleteBtn.setAttribute('data-index', index); actionsDiv.appendChild(deleteBtn);
        li.appendChild(actionsDiv); inputHistoryListElement.appendChild(li);
    });
}
function showError(message) { if (errorElement) { errorElement.textContent = message; setTimeout(() => { if (errorElement.textContent === message) errorElement.textContent = ''; }, 2500); } else { console.error("Error element not found."); } }
function easeOutQuart(t) { return 1 - Math.pow(1 - t, 4); }
function easeOutQuad(t) { return t * (2 - t); }
function spinRoulette() {
    if (isSpinning || !items || items.length === 0 || !sectorData || sectorData.length === 0) {
        if (!items || items.length === 0 || !sectorData || sectorData.length === 0) showError('ë£°ë ›ì— ìœ íš¨í•œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    spinSound.currentTime = 0;
    spinSound.play().catch(()=>{});
    isSpinning = true;
    isStopping = false;
    spinButton.disabled = true;
    spinButton.textContent = 'ë©ˆì¶”ê¸°';
    spinButton.classList.add('stop-mode');
    resultDisplay.textContent = 'ëŒì•„ê°€ëŠ” ì¤‘...';
    lastDisplayedSector = null;
    rouletteElement.style.transition = 'none';

    // ì…ë ¥ ê¸°ë¡ ì €ì¥ ë“± ê¸°ì¡´ ì½”ë“œ ìœ ì§€
    const currentDisplayedItems = [...items];
    if (currentDisplayedItems.length > 0) {
        const duplicateIndex = inputHistoryList.findIndex(entry => areItemSetsEqual(entry.items, currentDisplayedItems));
        if (duplicateIndex === -1) {
            inputHistoryList.unshift({ timestamp: Date.now(), items: currentDisplayedItems });
            if (inputHistoryList.length > 20) inputHistoryList.pop();
            updateInputHistoryDisplay();
        } else {
            const existing = inputHistoryList.splice(duplicateIndex, 1)[0];
            existing.timestamp = Date.now();
            inputHistoryList.unshift(existing);
            updateInputHistoryDisplay();
        }
    }
    saveData();

    // --- ê°ì† ì• ë‹ˆë©”ì´ì…˜ ë¡œì§ ---
    const duration = 7200; // 7.2ì´ˆ ê°ì†
    let startTime = null;
    let lastTimestamp = null;
    let initialSpeed = 1440; // 1ì´ˆì— 1440deg (4ë°”í€´), í•„ìš”ì‹œ ì¡°ì •
    let currentSpeed = initialSpeed;

    const step = (timestamp) => {
        if (!isSpinning || isStopping) {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
            return;
        }
        if (!startTime) {
            startTime = timestamp;
            lastTimestamp = timestamp;
            spinButton.disabled = false;
        }
        const elapsedTime = timestamp - startTime;
        const progress = Math.min(elapsedTime / duration, 1);
        const deltaTime = (timestamp - lastTimestamp) / 1000; // ì´ˆ ë‹¨ìœ„
        lastTimestamp = timestamp;

        // ì„ í˜• ê°ì†
        currentSpeed = initialSpeed * (1 - progress);

        currentRotation -= currentSpeed * deltaTime;
        rouletteElement.style.transform = `rotate(${currentRotation}deg)`;

        // ì„¹í„° í‘œì‹œ
        if (sectorData && sectorData.length > 0) {
            let currentPointerAngle = (180 - (currentRotation % 360) + 360) % 360;
            let currentSector = sectorData.find(sector => {
                const start = sector.startAngle % 360;
                let end = sector.endAngle % 360;
                const epsilon = 0.001;
                if (Math.abs(sector.endAngle - sector.startAngle) >= 360 - epsilon) return true;
                if (Math.abs(start - end) < epsilon && sector.endAngle > sector.startAngle) end = 360;
                if (start > end)
                    return currentPointerAngle >= start - epsilon || currentPointerAngle < end - epsilon;
                else
                    return currentPointerAngle >= start - epsilon && currentPointerAngle < end - epsilon;
            });
            if (currentSector && currentSector !== lastDisplayedSector) {
                currentItemNameElement.textContent = currentSector.name;
                lastDisplayedSector = currentSector;
            }
        }

        if (progress < 1) {
            animationFrameId = requestAnimationFrame(step);
        } else {
            currentSpeed = 0;
            animationFrameId = null;
            determineResult();
        }
    };

    if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
    }
    animationFrameId = requestAnimationFrame(step);
}
function stopRoulette() {
    if (!isSpinning || isStopping) return;
    isStopping = true;
    spinButton.disabled = true;
    spinButton.classList.remove('stop-mode');
    if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
    }
    spinSound.pause();
    spinSound.currentTime = 0;

    const stopDuration = 1000; // 1ì´ˆ ê°ì†
    let stopStartTime = null;
    let lastTimestamp = null;
    // í˜„ì¬ ì†ë„ë¥¼ ì¶”ì • (ì§ì „ í”„ë ˆì„ì˜ ê°ì† ê³µì‹ê³¼ ë™ì¼í•˜ê²Œ)
    let initialSpeed = 0;
    // ì¶”ì •: 1ì´ˆ ì „ íšŒì „ëŸ‰ìœ¼ë¡œ ê·¼ì‚¬ (í˜¹ì€ ë§ˆì§€ë§‰ currentSpeed ì‚¬ìš©)
    // ì•„ë˜ëŠ” ì´ì „ spinRouletteì˜ currentSpeedë¥¼ í™œìš©
    initialSpeed = typeof currentSpeed === "number" ? currentSpeed : 720; // fallback

    const stopStep = (timestamp) => {
        if (!isStopping) {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
            return;
        }
        if (!stopStartTime) {
            stopStartTime = timestamp;
            lastTimestamp = timestamp;
        }
        const elapsedTime = timestamp - stopStartTime;
        const progress = Math.min(elapsedTime / stopDuration, 1);
        const deltaTime = (timestamp - lastTimestamp) / 1000;
        lastTimestamp = timestamp;

        // ì„ í˜• ê°ì†
        let speed = initialSpeed * (1 - progress);

        currentRotation -= speed * deltaTime;
        rouletteElement.style.transform = `rotate(${currentRotation}deg)`;

        // ì„¹í„° í‘œì‹œ
        if (sectorData && sectorData.length > 0) {
            let currentPointerAngle = (180 - (currentRotation % 360) + 360) % 360;
            let currentSector = sectorData.find(sector => {
                const start = sector.startAngle % 360;
                let end = sector.endAngle % 360;
                const epsilon = 0.001;
                if (Math.abs(sector.endAngle - sector.startAngle) >= 360 - epsilon) return true;
                if (Math.abs(start - end) < epsilon && sector.endAngle > sector.startAngle) end = 360;
                if (start > end)
                    return currentPointerAngle >= start - epsilon || currentPointerAngle < end - epsilon;
                else
                    return currentPointerAngle >= start - epsilon && currentPointerAngle < end - epsilon;
            });
            if (currentSector && currentSector !== lastDisplayedSector) {
                currentItemNameElement.textContent = currentSector.name;
                lastDisplayedSector = currentSector;
            }
        }

        if (progress < 1) {
            animationFrameId = requestAnimationFrame(stopStep);
        } else {
            animationFrameId = null;
            determineResult();
        }
    };

    animationFrameId = requestAnimationFrame(stopStep);
}

function determineResult() {
    animationFrameId = null; isStopping = false;
    try {
        if (!sectorData || !Array.isArray(sectorData) || sectorData.length === 0) {
            throw new Error("ë£°ë › ë°ì´í„°(sectorData)ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }
        const finalRotation = currentRotation; const winningAngle = (180 - (finalRotation % 360) + 360) % 360;
        let winningSector = sectorData.find(sector => {
             const start = sector.startAngle % 360; let end = sector.endAngle % 360; const epsilon = 0.001;
             if (Math.abs(sector.endAngle - sector.startAngle) >= 360 - epsilon) return true;
             if (Math.abs(start - end) < epsilon && sector.endAngle > sector.startAngle) end = 360;
             if (start > end) return winningAngle >= start - epsilon || winningAngle < end - epsilon;
             else return winningAngle >= start - epsilon && winningAngle < end - epsilon;
        });
        if (!winningSector && sectorData.length > 0) {
             let minDist = 360, closestSector = null;
             sectorData.forEach(sector => {
                const midAngle = (sector.startAngle + sector.endAngle) / 2;
                const angleDiff = Math.abs(midAngle - winningAngle);
                const circularDiff = Math.min(angleDiff, 360 - angleDiff);
                if (circularDiff < minDist) { minDist = circularDiff; closestSector = sector; }
             });
             winningSector = closestSector;
        }
        if (winningSector) {
            resultDisplay.textContent = `ê²°ê³¼: ${winningSector.name}`;
            const newResultEntry = { name: winningSector.name, timestamp: Date.now() };
            resultHistoryList.unshift(newResultEntry); if (resultHistoryList.length > 20) resultHistoryList.pop();
            saveData();
            currentItemNameElement.textContent = winningSector.name;
            pointerLabelBoxWrapper.classList.add('blink-effect'); setTimeout(() => { pointerLabelBoxWrapper.classList.remove('blink-effect'); }, 3000);
            resultSound.volume = 0.7; resultSound.currentTime = 0; resultSound.play().catch(()=>{});
            setTimeout(() => { showCustomPopup(`ğŸ‰ ${winningSector.name} ğŸ‰`, winningSector.name); }, 100);
        } else { throw new Error("ë‹¹ì²¨ ì„¹í„°ë¥¼ íŒì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); }
    } catch (error) { currentItemNameElement.textContent = "ì˜¤ë¥˜"; setTimeout(() => { showCustomPopup(`ë£°ë › ê²°ê³¼ ê²°ì • ì¤‘ ì˜¤ë¥˜: ${error.message}`); }, 100); }
    finally {
        isSpinning = false; spinButton.textContent = 'ëŒë¦¬ê¸°'; spinButton.classList.remove('stop-mode');
        if (spinButton) spinButton.disabled = false; lastDisplayedSector = null;
    }
}
function closePopup() {
    // ê¸°ì¡´ íŒì—… ë‹«ê¸° ë™ì‘
    const overlay = document.querySelector('.popup-overlay');
    if (overlay) {
        overlay.style.opacity = '0';
        overlay.style.visibility = 'hidden';
        setTimeout(() => {
            if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
        }, 300);
    }
}
function createAndShowPopup(id, titleText, contentGenerator, showCloseButton = true) {
    closePopup();
    const overlay = document.createElement('div'); overlay.className = 'popup-overlay';
    const popup = document.createElement('div'); popup.className = 'popup-content'; popup.id = id;
    if (showCloseButton) {
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = '&times;';
        closeBtn.className = 'popup-close-btn';
        closeBtn.onclick = function(e) {
            if (favoritesList.some(fav => fav._editing)) {
                showCustomAlert('ë¨¼ì € ì¦ê²¨ì°¾ê¸° ì´ë¦„ì„ ì§€ì •í•˜ì„¸ìš”.');
                e.preventDefault();
                return false;
            }
            closePopup();
        };
        popup.appendChild(closeBtn);
    }
    const title = document.createElement('h2'); title.textContent = titleText; popup.appendChild(title);
    try { contentGenerator(popup); } catch (e) { const p=document.createElement('p');p.textContent="ì˜¤ë¥˜";p.style.color='red';popup.appendChild(p); }
    overlay.appendChild(popup); document.body.appendChild(overlay);
    setTimeout(() => { if (overlay) overlay.classList.add('visible'); }, 10);

    // ë°”ê¹¥ í´ë¦­
    overlay.addEventListener('mousedown', function(e) {
        if (e.target === overlay) {
            if (favoritesList.some(fav => fav._editing)) {
                showCustomAlert('ë¨¼ì € ì¦ê²¨ì°¾ê¸° ì´ë¦„ì„ ì§€ì •í•˜ì„¸ìš”.');
                e.preventDefault();
                return false;
            }
            closePopup();
        }
    });

    // ESCí‚¤
    document.addEventListener('keydown', function escHandler(e) {
        if (e.key === "Escape") {
            if (document.body.contains(overlay)) {
                if (favoritesList.some(fav => fav._editing)) {
                    showCustomAlert('ë¨¼ì € ì¦ê²¨ì°¾ê¸° ì´ë¦„ì„ ì§€ì •í•˜ì„¸ìš”.');
                    e.preventDefault();
                    return false;
                }
                closePopup();
                document.removeEventListener('keydown', escHandler);
            }
        }
    });
}
function showCustomPopup(message, winningItemName) {
    createAndShowPopup('customPopup', 'ë£°ë › ê²°ê³¼', (popup) => {
        const messageNode = document.createElement('p'); messageNode.textContent = message; messageNode.style.fontSize = '1.5em'; popup.appendChild(messageNode);
        const buttonGroup = document.createElement('div'); buttonGroup.className = 'popup-button-group';
        const removeBtn = document.createElement('button'); removeBtn.textContent = 'ì œê±°'; removeBtn.className = 'remove-btn';
        removeBtn.onclick = () => {
            if (winningItemName) {
                items = items.filter(item => item.name !== winningItemName);
                drawRoulette(items); closePopup();
            }
        };
        buttonGroup.appendChild(removeBtn);
        const closeBtn = document.createElement('button'); closeBtn.textContent = 'ë‹«ê¸°'; closeBtn.onclick = closePopup; buttonGroup.appendChild(closeBtn);
        popup.appendChild(buttonGroup);
    }, false);
}
function showHistoryPopup() {
    createAndShowPopup('historyPopup', 'ë‹¹ì²¨ ê²°ê³¼ ê¸°ë¡', (popup) => {
        const listContainer = document.createElement('div'); listContainer.className = 'popup-list-container'; const ul = document.createElement('ul'); ul.id = 'modalResultHistoryList';
        if (!resultHistoryList || resultHistoryList.length === 0) { ul.innerHTML = '<li>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</li>'; }
        else {
             resultHistoryList.forEach((entry, index) => {
                const li = document.createElement('li'); li.setAttribute('data-index', index);
                const nameSpan = document.createElement('span'); nameSpan.className = 'result-item-name'; nameSpan.textContent = entry.name; li.appendChild(nameSpan);
                const timestampSpan = document.createElement('span'); timestampSpan.className = 'result-timestamp'; timestampSpan.textContent = new Date(entry.timestamp).toLocaleString(); li.appendChild(timestampSpan);
                const actionsDiv = document.createElement('div'); actionsDiv.className = 'item-actions';
                const deleteBtn = document.createElement('button'); deleteBtn.innerHTML = '&#x2716;'; deleteBtn.classList.add('icon-button', 'delete-button', 'delete-result-history'); deleteBtn.title="ì‚­ì œ"; deleteBtn.setAttribute('data-index', index); actionsDiv.appendChild(deleteBtn);
                li.appendChild(actionsDiv); ul.appendChild(li);
            });
        }
        listContainer.appendChild(ul); popup.appendChild(listContainer); ul.addEventListener('click', handleModalResultHistoryInteraction);
        const buttonGroup = document.createElement('div'); buttonGroup.className = 'popup-button-group'; const closeBtn = document.createElement('button'); closeBtn.textContent = 'ë‹«ê¸°'; closeBtn.className = 'cancel-btn'; closeBtn.onclick = closePopup; buttonGroup.appendChild(closeBtn); popup.appendChild(buttonGroup);
    });
}
function showFavoritePromptPopup(itemsToSave) {
    createAndShowPopup('favoritePromptPopup', 'ì¦ê²¨ì°¾ê¸° ì œëª©ì„ ì§€ì •í•˜ì„¸ìš”.', (popup) => {
        const input = document.createElement('input'); input.type = 'text'; input.id = 'favoriteNameInput'; input.placeholder = 'ì¦ê²¨ì°¾ê¸° ì´ë¦„ (ë¯¸ì…ë ¥ ì‹œ ìë™ ì§€ì •)'; popup.appendChild(input);
        const buttonGroup = document.createElement('div'); buttonGroup.className = 'popup-button-group';
        const confirmBtn = document.createElement('button'); confirmBtn.textContent = 'í™•ì¸'; confirmBtn.className = 'confirm-btn';
        confirmBtn.onclick = () => {
            let favoriteName = input.value.trim();
            if (!favoriteName) {
                if (itemsToSave && itemsToSave.length > 0) {
                    favoriteName = itemsToSave[0].name; if (itemsToSave.length > 1) favoriteName += ` ì™¸ ${itemsToSave.length - 1}ê°œ`;
                    let counter = 1; let originalName = favoriteName; while (favoritesList.some(fav => fav.name === favoriteName)) { favoriteName = `${originalName} (${counter++})`; }
                } else { showCustomAlert('ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
            }
            if (favoritesList.some(fav => fav.name === favoriteName)) { showCustomAlert('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì¦ê²¨ì°¾ê¸° ì´ë¦„ì…ë‹ˆë‹¤.'); return; }
            favoritesList.unshift({ name: favoriteName, items: itemsToSave, timestamp: Date.now() });
            if (favoritesList.length > 50) favoritesList.pop();
            saveData(); updateInputHistoryDisplay(); closePopup();
        };
        const cancelBtn = document.createElement('button'); cancelBtn.textContent = 'ì·¨ì†Œ'; cancelBtn.className = 'cancel-btn'; cancelBtn.onclick = closePopup;
        buttonGroup.appendChild(confirmBtn); buttonGroup.appendChild(cancelBtn); popup.appendChild(buttonGroup); input.focus();
    }, false);
}
function showFavoriteEditPopup(index) {
    if (index < 0 || index >= favoritesList.length) return;
    const currentFavorite = favoritesList[index];
    createAndShowPopup('favoriteEditPopup', 'ì¦ê²¨ì°¾ê¸° ì´ë¦„ ìˆ˜ì •', (popup) => {
        const input = document.createElement('input'); input.type = 'text'; input.id = 'favoriteNameInput'; input.value = currentFavorite.name; popup.appendChild(input);
        const buttonGroup = document.createElement('div'); buttonGroup.className = 'popup-button-group';
        const confirmBtn = document.createElement('button'); confirmBtn.textContent = 'ìˆ˜ì •'; confirmBtn.className = 'confirm-btn';
        confirmBtn.onclick = () => {
            const newName = input.value.trim();
            if (newName && newName !== currentFavorite.name) {
                if (favoritesList.some((fav, i) => i !== index && fav.name === newName)) { showCustomAlert('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì¦ê²¨ì°¾ê¸° ì´ë¦„ì…ë‹ˆë‹¤.'); return; }
                favoritesList[index].name = newName; saveData(); showFavoritesPopup(); updateInputHistoryDisplay();
            } else if (!newName) { showCustomAlert('ì¦ê²¨ì°¾ê¸° ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); }
            else { closePopup(); }
        };
        const cancelBtn = document.createElement('button'); cancelBtn.textContent = 'ì·¨ì†Œ'; cancelBtn.className = 'cancel-btn'; cancelBtn.onclick = closePopup;
        buttonGroup.appendChild(confirmBtn); buttonGroup.appendChild(cancelBtn); popup.appendChild(buttonGroup); input.focus(); input.select();
    }, false);
}
function showFavoritesPopup() {
    createAndShowPopup('favoritesPopup', 'ì¦ê²¨ì°¾ê¸° ëª©ë¡', (popup) => {
        const listContainer = document.createElement('div');
        listContainer.className = 'popup-list-container';
        const ul = document.createElement('ul');
        ul.id = 'modalFavoritesList';
        if (!favoritesList || favoritesList.length === 0) {
            ul.innerHTML = '<li>ì¦ê²¨ì°¾ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
        } else {
            favoritesList.forEach((entry, index) => {
                const li = document.createElement('li');
                li.setAttribute('data-index', index);

                // ì¸ë¼ì¸ ìˆ˜ì • ëª¨ë“œ
                if (entry._editing) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = entry.name;
                    input.className = 'edit-favorite-input';
                    input.title = "ìƒˆ ì´ë¦„ ì…ë ¥";
                    li.appendChild(input);

                    // ì €ì¥ ë²„íŠ¼
                    const saveBtn = document.createElement('button');
                    saveBtn.innerHTML = 'âœ”ï¸';
                    saveBtn.className = 'save-edit-favorite';
                    saveBtn.setAttribute('data-index', index);
                    saveBtn.title = "ì €ì¥";
                    li.appendChild(saveBtn);

                    // ì·¨ì†Œ ë²„íŠ¼
                    const cancelBtn = document.createElement('button');
                    cancelBtn.innerHTML = 'âŒ';
                    cancelBtn.className = 'cancel-edit-favorite';
                    cancelBtn.setAttribute('data-index', index);
                    cancelBtn.title = "ì·¨ì†Œ";
                    li.appendChild(cancelBtn);

                    // ì‚­ì œ ë²„íŠ¼ì€ ìƒì„±í•˜ì§€ ì•ŠìŒ
                } else {
                    // ì´ë¦„ í‘œì‹œ (í´ë¦­ ì‹œ ì…ë ¥ì°½ì— ë°˜ì˜)
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'item-name';
                    nameSpan.textContent = entry.name;
                    nameSpan.title = "í´ë¦­ ì‹œ ì…ë ¥ì°½ì— ë°˜ì˜";
                    nameSpan.style.cursor = 'pointer';
                    nameSpan.onclick = function() {
                        const itemsToLoad = favoritesList[index].items;
                        const textLines = itemsToLoad.map(item => `${item.name}${item.ratio !== 1 ? '*' + item.ratio : ''}`);
                        dataInputElement.value = textLines.join('\n');
                        handleInput();
                        closePopup();
                        if (!document.body.classList.contains('panel-visible')) { togglePanel(); }
                    };
                    li.appendChild(nameSpan);

                    // âœï¸ ìˆ˜ì • ë²„íŠ¼
                    const editBtn = document.createElement('button');
                    editBtn.innerHTML = 'âœï¸';
                    editBtn.className = 'edit-favorite-btn';
                    editBtn.setAttribute('data-index', index);
                    editBtn.title = "ì´ë¦„ ìˆ˜ì •";
                    li.appendChild(editBtn);

                    // ì‚­ì œ ë²„íŠ¼
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '&#x2716;';
                    deleteBtn.classList.add('icon-button', 'delete-button', 'delete-favorite-button');
                    deleteBtn.title = "ì‚­ì œ";
                    deleteBtn.setAttribute('data-index', index);
                    li.appendChild(deleteBtn);
                }

                ul.appendChild(li);
            });
        }
        listContainer.appendChild(ul);
        popup.appendChild(listContainer);

        // ì¸ë¼ì¸ ìˆ˜ì • ì´ë²¤íŠ¸ ë°”ì¸ë”©
        ul.addEventListener('click', handleFavoritesPopupInlineEdit);

        const buttonGroup = document.createElement('div');
        buttonGroup.className = 'popup-button-group';
        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'ë‹«ê¸°';
        closeBtn.className = 'cancel-btn';
        closeBtn.onclick = closePopup;
        buttonGroup.appendChild(closeBtn);
        popup.appendChild(buttonGroup);
    });
}

// íŒì—… ë‚´ ê²°ê³¼ ê¸°ë¡ ì‚­ì œ ì²˜ë¦¬
function handleModalResultHistoryInteraction(event) {
    const target = event.target;
    if (target.classList.contains('delete-result-history')) {
        const index = parseInt(target.getAttribute('data-index'));
        if (!isNaN(index) && index >= 0 && index < resultHistoryList.length) {
            resultHistoryList.splice(index, 1);
            saveData();
            showHistoryPopup();
        }
    }
}

// ì¦ê²¨ì°¾ê¸° íŒì—… ë‚´ ì´ë²¤íŠ¸ ì²˜ë¦¬ (ë¶ˆëŸ¬ì˜¤ê¸°/ì‚­ì œ)
function handleFavoritesPopupInlineEdit(event) {
    const target = event.target;
    const li = target.closest('li');
    if (!li) return;
    const index = parseInt(li.getAttribute('data-index'));
    if (isNaN(index) || index < 0 || index >= favoritesList.length) return;

    // âœï¸ ìˆ˜ì • ë²„íŠ¼ í´ë¦­
    if (target.classList.contains('edit-favorite-btn')) {
        favoritesList.forEach(fav => delete fav._editing);
        favoritesList[index]._editing = true;
        showFavoritesPopup();
        setTimeout(() => {
            const input = document.querySelector('.edit-favorite-input');
            if (input) input.focus();
        }, 0);
    }
    // âœ”ï¸ ì €ì¥ ë²„íŠ¼
    else if (target.classList.contains('save-edit-favorite')) {
        const input = li.querySelector('.edit-favorite-input');
        const newName = input.value.trim();
        if (!newName) {
            showCustomAlert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
            input.focus();
            return;
        }
        if (favoritesList.some((fav, i) => i !== index && fav.name === newName)) {
            showCustomAlert('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë¦„ì…ë‹ˆë‹¤.');
            input.focus();
            return;
        }
        favoritesList[index].name = newName;
        delete favoritesList[index]._editing;
        saveData();
        showFavoritesPopup();
    }
    // âŒ ì·¨ì†Œ ë²„íŠ¼
    else if (target.classList.contains('cancel-edit-favorite')) {
        delete favoritesList[index]._editing;
        showFavoritesPopup();
    }
    // ì‚­ì œ ë²„íŠ¼
    else if (target.classList.contains('delete-favorite-button')) {
        if (confirm(`'${favoritesList[index].name}' ì¦ê²¨ì°¾ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            favoritesList.splice(index, 1);
            saveData();
            showFavoritesPopup();
        }
    }
}


// ì…ë ¥ ì„¸íŠ¸ ê¸°ë¡ ì¸í„°ë™ì…˜ (ì‚­ì œ/ì¦ê²¨ì°¾ê¸°/ë¶ˆëŸ¬ì˜¤ê¸°)
function handleInputHistoryInteraction(event) {
    const target = event.target;
    const li = target.closest('li');
    if (!li) return;
    const index = parseInt(li.getAttribute('data-index'));
    if (isNaN(index) || index < 0 || index >= inputHistoryList.length) return;

    if (target.classList.contains('delete-input-history')) {
        inputHistoryList.splice(index, 1);
        updateInputHistoryDisplay();
        saveData();
    } else if (target.classList.contains('favorite-button')) {
        const itemsToSave = inputHistoryList[index].items;
        // ì¦ê²¨ì°¾ê¸° ë“±ë¡ ì—¬ë¶€ í™•ì¸
        const favIndex = favoritesList.findIndex(fav => areItemSetsEqual(fav.items, itemsToSave));
        if (favIndex !== -1) {
            // ì´ë¯¸ ì¦ê²¨ì°¾ê¸°ë¼ë©´ ì œê±°
            favoritesList.splice(favIndex, 1);
            saveData();
            updateInputHistoryDisplay();
        } else {
            // ì•„ë‹ˆë©´ ì¶”ê°€ íŒì—…
            showFavoritePromptPopup(itemsToSave);
        }
    } else if (target.classList.contains('history-items')) {
        const itemsToLoad = inputHistoryList[index].items;
        const textLines = itemsToLoad.map(item => `${item.name}${item.ratio !== 1 ? '*' + item.ratio : ''}`);
        dataInputElement.value = textLines.join('\n');
        handleInput();
        if (!document.body.classList.contains('panel-visible')) { togglePanel(); }
    }
}

function handleFavoritesPopupInlineEdit(event) {
    const target = event.target;
    const li = target.closest('li');
    if (!li) return;
    const index = parseInt(li.getAttribute('data-index'));
    if (isNaN(index) || index < 0 || index >= favoritesList.length) return;

    // âœï¸ ìˆ˜ì • ë²„íŠ¼ í´ë¦­
    if (target.classList.contains('edit-favorite-btn')) {
        favoritesList.forEach(fav => delete fav._editing);
        favoritesList[index]._editing = true;
        showFavoritesPopup();
        setTimeout(() => {
            const input = document.querySelector('.edit-favorite-input');
            if (input) input.focus();
        }, 0);
    }
    // âœ”ï¸ ì €ì¥ ë²„íŠ¼
    else if (target.classList.contains('save-edit-favorite')) {
        const input = li.querySelector('.edit-favorite-input');
        const newName = input.value.trim();
        if (!newName) {
            showCustomAlert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
            input.focus();
            return;
        }
        if (favoritesList.some((fav, i) => i !== index && fav.name === newName)) {
            showCustomAlert('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë¦„ì…ë‹ˆë‹¤.');
            input.focus();
            return;
        }
        favoritesList[index].name = newName;
        delete favoritesList[index]._editing;
        saveData();
        showFavoritesPopup();
    }
    // âŒ ì·¨ì†Œ ë²„íŠ¼
    else if (target.classList.contains('cancel-edit-favorite')) {
        delete favoritesList[index]._editing;
        showFavoritesPopup();
    }
    // ì‚­ì œ ë²„íŠ¼
    else if (target.classList.contains('delete-favorite-button')) {
        if (confirm(`'${favoritesList[index].name}' ì¦ê²¨ì°¾ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            favoritesList.splice(index, 1);
            saveData();
            showFavoritesPopup();
        }
    }
}


function showCustomAlert(message) {
    // ì´ë¯¸ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
    const old = document.getElementById('customAlertModal');
    if (old) old.parentNode.removeChild(old);

    // ì˜¤ë²„ë ˆì´
    const overlay = document.createElement('div');
    overlay.className = 'popup-overlay visible';
    overlay.id = 'customAlertModal';

    // íŒì—… ë‚´ìš©
    const popup = document.createElement('div');
    popup.className = 'popup-content';
    popup.style.minWidth = '260px';
    popup.innerHTML = `
        <h2>ì•Œë¦¼</h2>
        <p style="margin: 20px 0 10px 0; font-size: 1.1em;">${message}</p>
        <div class="popup-button-group">
            <button class="confirm-btn" style="min-width:80px;">í™•ì¸</button>
        </div>
    `;

    // ë‹«ê¸° ë²„íŠ¼ ë™ì‘
    popup.querySelector('.confirm-btn').onclick = () => {
        overlay.classList.remove('visible');
        setTimeout(() => {
            if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
        }, 200);
    };

    overlay.appendChild(popup);
    document.body.appendChild(overlay);
}


</script>
</body>
</html>
